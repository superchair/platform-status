server {
  listen 5173;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # Serve static files and fallback to index.html for SPA routes
  location / {
    try_files $uri $uri/ /index.html;
  }

  # --- API Proxies (mirror Vite dev proxies) ---
  # Dev cluster
  location ^~ /dev/dealer-service/ {
    proxy_ssl_server_name on;
    rewrite ^/dev/dealer-service/(.*)$ /$1 break;
    proxy_pass https://dealer-service.dev.autoverify.services;
  }
  location ^~ /dev/consumer-core/ {
    proxy_ssl_server_name on;
    rewrite ^/dev/consumer-core/(.*)$ /$1 break;
    proxy_pass https://consumer-core.dev.autoverify.services;
  }
  location ^~ /dev/lender-aggregator-proxy-service/ {
    proxy_ssl_server_name on;
    rewrite ^/dev/lender-aggregator-proxy-service/(.*)$ /$1 break;
    proxy_pass https://lender-aggregator-proxy-service.dev.autoverify.services;
  }
  location ^~ /dev/otp-service/ {
    proxy_ssl_server_name on;
    rewrite ^/dev/otp-service/(.*)$ /$1 break;
    proxy_pass https://otp-service.dev.autoverify.services;
  }
  location ^~ /dev/crm-integration-service/ {
    proxy_ssl_server_name on;
    rewrite ^/dev/crm-integration-service/(.*)$ /$1 break;
    proxy_pass https://crm-integration-service.dev.autoverify.services;
  }
  location ^~ /dev/vin-decoder/ {
    proxy_ssl_server_name on;
    rewrite ^/dev/vin-decoder/(.*)$ /$1 break;
    proxy_pass https://vin-decoder.dev.autoverify.services;
  }
  location ^~ /dev/inventory-core-service/ {
    proxy_ssl_server_name on;
    rewrite ^/dev/inventory-core-service/(.*)$ /$1 break;
    proxy_pass https://inventory-core-service.dev.autoverify.services;
  }
  location ^~ /dev/url-shortener/ {
    proxy_ssl_server_name on;
    rewrite ^/dev/url-shortener/(.*)$ /$1 break;
    proxy_pass https://url-shortener.dev.autoverify.services;
  }
  location ^~ /dev/consumer-authentication-service/ {
    proxy_ssl_server_name on;
    rewrite ^/dev/consumer-authentication-service/(.*)$ /$1 break;
    proxy_pass https://consumer-authentication-service.dev.autoverify.services;
  }

  # Staging cluster
  location ^~ /staging/dealer-service/ {
    proxy_ssl_server_name on;
    rewrite ^/staging/dealer-service/(.*)$ /$1 break;
    proxy_pass https://dealer-service.stage.autoverify.services;
  }
  location ^~ /staging/consumer-core/ {
    proxy_ssl_server_name on;
    rewrite ^/staging/consumer-core/(.*)$ /$1 break;
    proxy_pass https://consumer-core.stage.autoverify.services;
  }
  location ^~ /staging/lender-aggregator-proxy-service/ {
    proxy_ssl_server_name on;
    rewrite ^/staging/lender-aggregator-proxy-service/(.*)$ /$1 break;
    proxy_pass https://lender-aggregator-proxy-service.stage.autoverify.services;
  }
  location ^~ /staging/otp-service/ {
    proxy_ssl_server_name on;
    rewrite ^/staging/otp-service/(.*)$ /$1 break;
    proxy_pass https://otp-service.stage.autoverify.services;
  }
  location ^~ /staging/crm-integration-service/ {
    proxy_ssl_server_name on;
    rewrite ^/staging/crm-integration-service/(.*)$ /$1 break;
    proxy_pass https://crm-integration-service.stage.autoverify.services;
  }
  location ^~ /staging/vin-decoder/ {
    proxy_ssl_server_name on;
    rewrite ^/staging/vin-decoder/(.*)$ /$1 break;
    proxy_pass https://vin-decoder.stage.autoverify.services;
  }
  location ^~ /staging/inventory-core-service/ {
    proxy_ssl_server_name on;
    rewrite ^/staging/inventory-core-service/(.*)$ /$1 break;
    proxy_pass https://inventory-core-service.stage.autoverify.services;
  }
  location ^~ /staging/url-shortener/ {
    proxy_ssl_server_name on;
    rewrite ^/staging/url-shortener/(.*)$ /$1 break;
    proxy_pass https://url-shortener.stage.autoverify.services;
  }
  location ^~ /staging/consumer-authentication-service/ {
    proxy_ssl_server_name on;
    rewrite ^/staging/consumer-authentication-service/(.*)$ /$1 break;
    proxy_pass https://consumer-authentication-service.stage.autoverify.services;
  }

  # Production cluster
  location ^~ /prod/dealer-service/ {
    proxy_ssl_server_name on;
    rewrite ^/prod/dealer-service/(.*)$ /$1 break;
    proxy_pass https://dealer-service.autoverify.services;
  }
  location ^~ /prod/consumer-core/ {
    proxy_ssl_server_name on;
    rewrite ^/prod/consumer-core/(.*)$ /$1 break;
    proxy_pass https://consumer-core.autoverify.services;
  }
  location ^~ /prod/lender-aggregator-proxy-service/ {
    proxy_ssl_server_name on;
    rewrite ^/prod/lender-aggregator-proxy-service/(.*)$ /$1 break;
    proxy_pass https://lender-aggregator-proxy-service.autoverify.services;
  }
  location ^~ /prod/otp-service/ {
    proxy_ssl_server_name on;
    rewrite ^/prod/otp-service/(.*)$ /$1 break;
    proxy_pass https://otp-service.autoverify.services;
  }
  location ^~ /prod/crm-integration-service/ {
    proxy_ssl_server_name on;
    rewrite ^/prod/crm-integration-service/(.*)$ /$1 break;
    proxy_pass https://crm-integration-service.autoverify.services;
  }
  location ^~ /prod/vin-decoder/ {
    proxy_ssl_server_name on;
    rewrite ^/prod/vin-decoder/(.*)$ /$1 break;
    proxy_pass https://vin-decoder.autoverify.services;
  }
  location ^~ /prod/inventory-core-service/ {
    proxy_ssl_server_name on;
    rewrite ^/prod/inventory-core-service/(.*)$ /$1 break;
    proxy_pass https://inventory-core-service.autoverify.services;
  }
  location ^~ /prod/url-shortener/ {
    proxy_ssl_server_name on;
    rewrite ^/prod/url-shortener/(.*)$ /$1 break;
    proxy_pass https://url-shortener.autoverify.services;
  }
  location ^~ /prod/consumer-authentication-service/ {
    proxy_ssl_server_name on;
    rewrite ^/prod/consumer-authentication-service/(.*)$ /$1 break;
    proxy_pass https://consumer-authentication-service.autoverify.services;
  }

  # Optional: gzip
  gzip on;
  gzip_types text/plain text/css application/javascript application/json image/svg+xml;
  gzip_min_length 1024;
}
